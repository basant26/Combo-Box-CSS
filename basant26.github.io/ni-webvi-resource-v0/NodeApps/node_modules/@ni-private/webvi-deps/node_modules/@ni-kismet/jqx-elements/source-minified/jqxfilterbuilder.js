"use strict";JQX("jqx-filter-builder",function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"template",value:function(){return'<div id="container" title="[[hint]]">\n                    <div id="innerContainer" class ="jqx-inner-container">\n                            <div id="scrollableOuterContainer" class ="jqx-scrollable-outer-container">\n                                <jqx-scroll-viewer id="scrollableContainer" class ="jqx-scrollable-container" animation="[[animation]]">\n                                    <div id="contentContainer" class ="jqx-content-container"></div>\n                                </jqx-scroll-viewer>\n                            </div>\n                            <div id="editorsContainer" class ="jqx-editors-container">\n                                <div id="customEditor" class ="jqx-custom-editor jqx-hidden"></div>\n                            </div>\n                    </div>\n                    <jqx-menu id="conditionsMenu" mode="dropDown" class ="jqx-conditions-menu" theme="[[theme]]" animation="[[animation]]"></jqx-menu>\n            </div>'}},{key:"propertyChangedHandler",value:function(e,a,i){var n=this,r=["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"];switch(babelHelpers.get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"propertyChangedHandler",this).call(this,e,a,i),e){case"animation":case"theme":r.forEach(function(t){return n.$[t]&&(n.$[t][e]=i)});break;case"customOperations":n._handleCustomOperations(),n._refresh();break;case"fields":n._mapFieldsToMenu(),n._refresh();break;case"formatStringDate":case"formatStringDateTime":case"showIcons":case"valueFormatFunction":n._refresh();break;case"locale":case"messages":n._localizeInitialValues(),n._refresh(),n._handleCustomOperations(),n.$.dateTimePickerEditor&&(n.$.dateTimePickerEditor.messages[n.locale]||(n.$.dateTimePickerEditor.messages[n.locale]={}),n.$.dateTimePickerEditor.messages[n.locale].dateTabLabel=n.localize("dateTabLabel"),n.$.dateTimePickerEditor.messages[n.locale].timeTabLabel=n.localize("timeTabLabel"),"locale"===e?n.$.dateTimePickerEditor.locale=n.locale:"messages"===e&&(n.$.dateTimePickerEditor.$.selectDate.innerHTML=n.$.dateTimePickerEditor.messages[n.locale].dateTabLabel,n.$.dateTimePickerEditor.$.selectTime.innerHTML=n.$.dateTimePickerEditor.messages[n.locale].timeTabLabel));break;case"maxConditions":case"maxConditionsPerGroup":case"maxLevel":case"value":n._totalConditions=0,n._validateValue(),n._emptyElementsStructure(!0),n._convertValueToFlat(n.value),n._getFieldsFromValue(),n._mapFieldsToMenu(),n._generateHTMLStructureFromFlatValue(),n.$.scrollableContainer.refresh();var l=JSON.stringify(n.value);n._oldValueAsString!==l&&(n._oldValueAsString=l,n.$.fireEvent("change",{value:JSON.parse(l)}));break;case"valuePlaceholder":n._updatePlaceholder()}}},{key:"_maxValidator",value:function(e,t){return"number"!=typeof t?t:Math.max(1,t)}},{key:"ready",value:function(){babelHelpers.get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"ready",this).call(this);var e=this;e._validateValue(),e._setInitialValues(),e._handleCustomOperations(),e._emptyElementsStructure(!0),e._totalConditions=0,e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._generateHTMLStructureFromFlatValue(),e.$.conditionsMenu._noAutoFocus=!0,e._oldValueAsString=JSON.stringify(e.value),e.$.scrollableContainer.refresh()}},{key:"addCondition",value:function(e,t){var a=this;a._checkFieldsExistence(),a._addElement("condition",e,t)}},{key:"addGroup",value:function(e,t){this._addElement("group",e,t)}},{key:"removeCondition",value:function(e){var t=this;t._validateNode(e,"removeCondition"),t._deleteElement(e,"condition"),t._refresh()}},{key:"removeGroup",value:function(e){var t=this;t._validateNode(e,"removeGroup"),t._deleteElement(e,"group"),t._refresh()}},{key:"toString",value:function(e){var t=this;if(!e)return JSON.stringify(t.value);for(var a=[],i=[],n=0;n<t._valueFlat.length;n++){var r=t._valueFlat[n],l={};if("condition"===r.type){var o=t._getFieldByFieldName(r.data[0]),d=o.dataType,s="["+(o.label||o.value)+"]",u=t.localize(r.data[1]),c=-1!==["boolean","number"].indexOf(d)?r.data[2]+"":"'"+r.data[2]+"'";l.data=s+" "+u+" "+c}else l.data=r.data;l.nodeId=r.nodeId,l.parentId=r.parentId,l.type=r.type,a.push(l)}for(var v=0;v<a.length;v++)!function(e){var n=a[e],r={};if("group"===n.type){var l=a.filter(function(e){return e.parentId===n.nodeId&&"condition"===e.type});if(l.length>0){var o=l.map(function(e){return e.data}),d="",s="",u=n.data;-1!==["notand","notor"].indexOf(u)&&(d="Not (",s=")",u=u.substring(3)),r.nodeId=n.nodeId,r.parentId=n.parentId,r.data=n.data,r.structure=d+o.join(" "+t.localize(u)+" ")+s,i.push(r)}}}(v);i=i.filter(function(e){return e.structure.length>1}),i.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(var p=0;p<i.length;p++)!function(e){var a=i[e],n=i.filter(function(e){return e.nodeId===a.parentId})[0];if(n&&n.structure){var r=n.data;-1!==["notand","notor"].indexOf(r)?(r=r.substring(3),n.structure=n.structure.slice(0,n.structure.length-1)+" "+t.localize(r)+" ("+a.structure+"))"):n.structure=n.structure+" "+t.localize(r)+" ("+a.structure+")"}}(p);return i[i.length-1].structure}},{key:"updateCondition",value:function(e,t){var a=this,i=a._validateNode(e,"updateCondition");a._validateUserData(t,!0),i.data=t,a._refresh()}},{key:"updateGroup",value:function(e,t){var a=this,i=a._validateNode(e,"updateGroup");a._validateUserData(t),i.data=t,a._refresh()}},{key:"_addElement",value:function(e,t,a){t=t||"0";var i=this,n=i._valueFlat.filter(function(e){return e.nodeId===t&&"group"===e.type}),r=n.length>0&&n[0],l=i._valueFlat.filter(function(e){return e.parentId===t}),o=0,d="";if(r||i.error(i.localize("wrongParentGroupIndex",{elementType:i.nodeName.toLowerCase(),method:"addGroup/addCondition"})),"group"===e)a=a||"or";else{if(l.filter(function(e){return"condition"===e.type}).length===i.maxConditionsPerGroup||i._totalConditions===i.maxConditions)return;var s=i.fields&&i.fields.length>0?i.fields[0].dataField:i._valueFields[0].dataField;i._totalConditions++,a=a||[],a[0]=a[0]||s,a[1]=a[1]||"=",a[2]=void 0!==babelHelpers.typeof(a[2])?a[2]:null}if(l){var u=l.map(function(e){var t=e.nodeId.split(".");return parseInt(t[t.length-1])});u=0===u.length?[0]:u,o=u.reduce(function(e,t){return Math.max(e,t)})+1}t&&t.length>0&&(d=".");var c=t+d+o,v={nodeId:c,parentId:t,type:e,data:a,htmlNode:null};i._valueFlat.push(v),i._refresh()}},{key:"_clearConditionsValue",value:function(e,t){for(var a=this,i=(a.shadowRoot||a).querySelector('[node-id="'+(e||0)+'"]'),n=i.querySelector(".jqx-value-container"),r=0;r<a._valueFlat.length;r++)a._valueFlat[r].nodeId===e&&function(){var e=a._valueFlat[r],i=t?a.fields.find(function(e){return e.dataField===t}).dataType:a.fields.find(function(t){return t.dataField===e.data[0]}).dataType;e.data[2]=a._defaultValueByType(i)}();n.innerHTML=a.valuePlaceholder,n.closest(".jqx-filter-value").setAttribute("placeholder","")}},{key:"_convertValueToFlat",value:function(e,t){var a=this,i=/^(and|or|notAnd|notOr)$/i;if(e){var n=e.filter(function(e){return"string"==typeof e&&e.match(i)}),r=n?n[0]:null,l=e.filter(function(e){return Array.isArray(e)&&3===e.length&&0===e.filter(function(e){return"string"==typeof e&&e.match(i)}).length}),o=e.filter(function(e){return!l.includes(e)&&e!==r});if(n){var d=a._lastProcessedItemInCurrentGroup.parentId?".":"",s=(a._lastProcessedItemInCurrentGroup.parentId||"")+d+(t||0);if(!a._isMaxLevelExceeded(s)){var u={nodeId:s,parentId:a._lastProcessedItemInCurrentGroup.parentId,type:"group",data:r,htmlNode:null};a._valueFlat.push(u),a._lastProcessedItemInCurrentGroup.position=0;for(var c=0;c<l.length&&l[c];c++){var v=s+"."+(a._lastProcessedItemInCurrentGroup.position||0);if(a._isMaxLevelExceeded(v))break;var p={nodeId:v,parentId:s,type:"condition",data:l[c],htmlNode:null};a._totalConditions++,a._valueFlat.push(p),a._lastProcessedItemInCurrentGroup.position++}for(var f=0;f<o.length;f++)a._lastProcessedItemInCurrentGroup.parentId=s,a._convertValueToFlat(o[f],l.length+f),a._lastProcessedItemInCurrentGroup.position++}}}}},{key:"_isMaxLevelExceeded",value:function(e){var t=this,a=t._valueFlat;if(!(null===t.maxLevel||a.length<1)){if(e)return e.split(".").length-2>=t.maxLevel;for(var i=0;i<a.length;i++){if(a[i].nodeId.split(".").length-2>t.maxLevel)return!0}}}},{key:"_clickHandler",value:function(e){var t=this,a=t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target,i=a?a.closest(".jqx-filter-group-condition"):null,n=i?i.getAttribute("node-id"):null,r=a?a.closest(".jqx-filter-group"):null,l=r?r.getAttribute("node-id"):null,o=a.closest(".jqx-filter-add-btn"),d=a.closest(".jqx-filter-delete-btn"),s=a.closest(".filter-builder-item"),u=n||l,c=t._getItemById(u),v=void 0;if(!t.disabled){if((s||d||o)&&(v=s?s.classList.contains("jqx-filter-field-name")?"fieldButton":s.classList.contains("jqx-filter-operation")?"operationButton":s.classList.contains("jqx-filter-value")?"valueButton":"groupOperationButton":o?"addButton":"deleteButton",t.$.fireEvent("itemClick",{id:c.nodeId,type:c.type,component:v,data:c.data})),d){var p=a.closest(".jqx-filter-group-operator"),f=a.closest(".jqx-filter-group-condition");return void t._clickHandlerDeleteButton(p,f,r)}if(o)return t._closeEditor(),t._contextMenuOptions=t._addOptions,void t._handleContextMenu(a);if(s){var m=s.classList;return void t._clickHandlerFilterButton(m,u,a)}t.$.conditionsMenu.opened&&(t.$.fireEvent("menuClosing"),t.$.conditionsMenu.close(),t.$.fireEvent("menuClose"));var _=a.closest(".jqx-drop-down"),h=t._editor&&t._editor.contains(a)||_&&_.ownerElement===t._editor||a.closest(".jqx-custom-editor");if(t._editorIsOpen&&t._editor&&!h)return t._scrollBarDown?void delete t._scrollBarDown:void t._closeEditor()}}},{key:"_clickHandlerDeleteButton",value:function(e,t,a){var i=this;i.$.conditionsMenu.opened&&(i.$.fireEvent("menuClosing"),i.$.conditionsMenu.close(),i.$.fireEvent("menuClose")),i._closeEditor(),e?(i._deleteElement(a,"group"),i._generateValue()):t&&(i._deleteElement(t),i._generateValue()),i.$.scrollableContainer.refresh()}},{key:"_clickHandlerFilterButton",value:function(e,t,a){function i(){var e=r.$.conditionsMenu.querySelector(".jqx-selected-menu-item");e&&e.classList.remove("jqx-selected-menu-item")}function n(e,t,a){i(),r._contextMenuOptions=0===t.length?r._defaultFilterOperationDescriptions:t,r._handleContextMenu(e);var n=a,l=r.$.conditionsMenu.querySelector('jqx-menu-item[value="'+n+'"]');r.$.conditionsMenu.opened&&l&&l.classList.add("jqx-selected-menu-item")}var r=this;if(!a.closest(".jqx-editors-container")&&(r._closeEditor(),r._editedItem=r._getItemById(t),e.contains("jqx-filter-field-name")||r._editedItem.data&&r._editedItem.data.length)){if(e.contains("jqx-filter-group-operation"))return void n(a,r._groupOperationDescriptions,r._editedItem.data);if(!e.contains("jqx-filter-add-btn")){if(e.contains("jqx-filter-field-name"))return r._fields||r._mapFieldsToMenu(),void n(a,r._fields,r._editedItem.data[0]);if(e.contains("jqx-filter-operation")){var l=r._getFieldByFieldName(r._editedItem.data[0]);if(!l)return;var o=r._filterOperationDescriptions.slice();if(l&&l.filterOperations)o=r._filterOperationDescriptions.filter(function(e){return l.filterOperations.indexOf(e.value)>-1});else{var d=void 0;switch(l.dataType){case"number":case"date":case"datetime":d=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":d=["=","<>","isblank","isnotblank"];break;case"object":d=["isblank","isnotblank"];break;case"string":d=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:d=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"]}o=r._filterOperationDescriptions.filter(function(e){return d.indexOf(e.value)>-1})}return r.showIcons&&(o=o.map(function(e){return e.label='<div class="jqx-filter-builder-icon">'+r.icons[e.value]+'</div><div class="jqx-filter-builder-menu-item">'+r.localize(e.value)+"</div>",e})),void n(a,o.slice(),r._editedItem.data[1])}return void r._openEditor(a)}n(a,r._groupOperationDescriptions)}}},{key:"_closeEditor",value:function(e){var t=this,a=void 0;if(t._editedItem&&t._editorIsOpen){if(t._editor===t.$.dateTimePickerEditor)(a=t._editor.value)&&(a=a.toDate());else if(t._editor===t.$.checkBoxEditor)a=t._editor.checked;else if(t._editor===t.$.customEditor)a=t._selectedCustomCondition.handleValue(t._editor);else{var i=t._getFieldByFieldName(t._editedItem.data[0]);a="array"===i.dataType?t._editor.value.split(","):"object"===i.dataType?JSON.parse(t._editor.value):t._editor.value}var n=t._editedItem,r=n.htmlNode,l=n.nodeId,o=t._getFieldByFieldName(n.data[0]).dataType,d=r.querySelector(".jqx-filter-value"),s=r.querySelector(".jqx-value-container"),u={value:a,valueType:o||"string",editedItem:n};if(t.$.fireEvent("editorClosing",u),t._updateValueInFlatArray(l,a,"value",o||"string"),t._generateValue(e),d.removeAttribute("edited"),t.$.editorsContainer.removeAttribute("open"),t._editor===t.$.checkBoxEditor)s.innerHTML=t._editor.checked?"true":"false";else if(t._editor===t.$.customEditor){var c=t._selectedCustomCondition.valueTemplate(t._editor);s.innerHTML=c}else s.innerHTML=t._formatValueStringRepresentation(t._editor.value,t._editedItem.data[0]);t._editor.classList.add("jqx-hidden"),t._editorIsOpen=t._enterIsPressedInEditor=!1,t.$.fireEvent("editorClose",u),t.$.scrollableContainer.refresh()}}},{key:"_defaultValueByType",value:function(e){var t=void 0;switch(e){case"number":t=0;break;case"date":case"datetime":t=new Date,t.setHours(0,0,0);break;case"boolean":t=!1;break;case"object":t=null;break;default:t=""}return t}},{key:"_deleteElement",value:function(e,t){function a(e){var t=r._valueFlat.filter(function(t){return e===t.nodeId}),a=t?t[0]:null;r._valueFlat.splice(r._valueFlat.indexOf(a),1),r._totalConditions--}function i(e){for(var t=r._valueFlat.filter(function(t){return e===t.nodeId}),n=t?t[0]:null,l=0;l<r._valueFlat.length;l++){var o=r._valueFlat[l],d=o.nodeId;o.parentId===e&&("group"===o.type?i(d):a(d))}r._valueFlat.indexOf(n)>-1&&r._valueFlat.splice(r._valueFlat.indexOf(n),1)}function n(e,t){e.forEach(function(e,a){var i=r._valueFlat.find(function(t){return t.htmlNode===e}),l=t+"."+a;e.setAttribute("node-id",l),i.parentId=t,i.nodeId=l,e.classList.contains("jqx-filter-group")&&n(Array.from(e.children[1].children),l)})}var r=this,l=e instanceof HTMLElement?e:r._valueFlat.find(function(t){return t.nodeId===e}).htmlNode,o="string"==typeof e?e:e.getAttribute("node-id");if(o&&1!==o.length){"group"===t?i(o):a(o);for(var d=r._valueFlat.length-1;d>=0;d--)!function(e){0===r._valueFlat.filter(function(t){return r._valueFlat[e].parentId===t.nodeId}).length&&"0"!==r._valueFlat[e].nodeId&&(r._valueFlat.splice(e,1),r._totalConditions--)}(d);r._generateValue(),l.parentElement.removeChild(l),n(Array.from(r.$.contentContainer.firstElementChild.children[1].children),"0")}}},{key:"_documentClickHandler",value:function(e){var t=this;if((t.isInShadowDOM?e.composedPath()[0]:e.target).closest("jqx-filter-builder"))return void t._clickHandler(e);t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown}},{key:"_downHandler",value:function(e){var t=this;(t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target).closest("jqx-scroll-bar")?t._scrollBarDown=!0:delete t._scrollBarDown}},{key:"_containerChangeHandler",value:function(e){e.stopPropagation()}},{key:"_emptyElementsStructure",value:function(e){for(var t=this,a=t.$.contentContainer;a.firstChild;)a.removeChild(a.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}},{key:"_filterGroupRow",value:function(e){e=this.localize(e||"or");var t=document.createElement("div"),a='<span class ="jqx-filter-delete-btn"></span>\n                <span class ="filter-builder-item jqx-filter-group-operation">'+e+'</span>\n                <span class ="jqx-filter-add-btn"></span>';return t.className="jqx-filter-group-operator",t.innerHTML=a,t.data=e||"or",t}},{key:"_formatValueStringRepresentation",value:function(e,t){var a=this,i=a._getFieldByFieldName(t),n=void 0;if(!i)return e;if((!e||0===e.length)&&"boolean"!==i.dataType&&"number"===i.dataType&&null===e||"string"===i.dataType&&(!e||0===e.length))return a.valuePlaceholder;switch(i.dataType){case"date":case"datetime":e?(e=function(e){return 0===e||"number"==typeof e||"string"==typeof e||!0===e||""===e||"0"===e||Array.isArray(e)||"object"===(void 0===e?"undefined":babelHelpers.typeof(e))&&e.constructor===Date?new JQX.Utilities.DateTime(e):e}(e),e.calendar.days=a._localizedDays,e.calendar.months=a._localizedMonths,e.calendar.locale=a.locale,JQX.Utilities.DateTime.cache=[],n=e.toString("date"===i.dataType?a.formatStringDate:a.formatStringDateTime)):n=a.valuePlaceholder;break;case"array":n="string"==typeof e?e.split(","):e;break;case"object":n="string"==typeof e?e:JSON.stringify(e);break;case"number":n=e;break;case"boolean":n=!1===e?"false":"true";break;default:n=e+""}return a.valueFormatFunction?a.valueFormatFunction(n,t,i.dataType||"string"):n}},{key:"_generateHTMLStructureFromFlatValue",value:function(){var e=this,t=document.createDocumentFragment();if(e._valueFlat&&0!==e._valueFlat.length)for(var a=0;a<e._valueFlat.length;a++)!function(a){var i=e._valueFlat[a],n=!!e.customOperations&&e.customOperations.find(function(e){return e.name===i.data[1]}),r=i.parentId?(e.shadowRoot||e).querySelector('[node-id="'+i.parentId+'"]').querySelector(".jqx-filter-group-condition-container"):e.$.contentContainer;if("group"===i.type){var l=document.createElement("div"),o=e._filterGroupRow(i.data),d=document.createElement("div");l.className="jqx-filter-group",d.className="jqx-filter-group-condition-container",l.appendChild(o),l.appendChild(d),t.appendChild(l),l.setAttribute("node-id",i.nodeId),e._valueFlat[a].htmlNode=l,e._isMaxLevelExceeded(i.nodeId+".0")&&l.setAttribute("max-level","")}else{var s=e._newFilterConditionRow(i.data);s.setAttribute("node-id",i.nodeId),t.appendChild(s),e._valueFlat[a].htmlNode=s,(-1!==["isblank","isnotblank"].indexOf(i.data[1])||n&&n.hideValue)&&s.children[3].classList.add("jqx-hidden")}r.appendChild(t)}(a)}},{key:"_generateValue",value:function(){var e=this,t=[],a=e._valueFlat.slice();!function(e){for(var a=0;a<e.length;a++){var i=e[a],n={};"group"===i.type&&(n.nodeId=i.nodeId,n.parentId=i.parentId,n.structure=[i.data||"or"],t.push(n))}for(var r=0;r<t.length;r++)!function(a){for(var i=t[a],n=e.filter(function(e){return e.parentId===i.nodeId&&"condition"===e.type}),r=0;r<n.length;r++)0===r?i.structure.unshift(n[r].data):i.structure.push(n[r].data)}(r);t=t.filter(function(e){return e.structure.length>1}),t.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(var l=0;l<t.length;l++)!function(e){var a=t[e],i=t.filter(function(e){return e.nodeId===a.parentId})[0];i&&i.structure&&i.structure.push(a.structure)}(l)}(a),t.length>0?e.value=e._valueFlat.length>1?t[t.length-1].structure:t:e.value=[e._getItemById("0").data];var i=JSON.stringify(e.value);e._oldValueAsString!==i&&(e._oldValueAsString=i,e.$.fireEvent("change",{value:JSON.parse(i)}))}},{key:"_getFieldByFieldName",value:function(e){var t=this;return(t.fields?t.fields.filter(function(t){return t.dataField===e}):t._valueFields.filter(function(t){return t.dataField===e}))[0]||null}},{key:"_getFieldsFromValue",value:function(){for(var e=this,t=e._valueFlat,a=[],i=[],n=0;n<t.length;n++)if("condition"===t[n].type){var r=t[n].data[0];if(-1===a.indexOf(r)){var l={label:r,dataField:r,dataType:"string",format:null};a.push(r),i.push(l)}}e._valueFields=i}},{key:"_getItemById",value:function(e,t){var a=this,i=a._valueFlat.filter(function(a){return t?a.parentId===e:a.nodeId===e});return i.length>0?i[0]:null}},{key:"_handleContextMenu",value:function(e){var t=this;if(t._selectedElement!==e||!t.$.conditionsMenu.opened){var a=e.getBoundingClientRect(),i=t.getBoundingClientRect(),n=a.height,r=a.left+t.$.contentContainer.scrollLeft-i.left,l=a.top+t.$.contentContainer.scrollTop-i.top+n;if(e.closest(".jqx-filter-add-btn")&&t.restrictedMode){t._checkFieldsExistence();var o=t.fields?t.fields[0]:t._valueFields[0],d=o.filterOperations&&o.filterOperations.length>0?o.filterOperations[0]:"=";return void t._addElement("condition",0,[o.dataField,d,t._defaultValueByType(o.dataType)])}if(t._closeEditor(),t.disableContextMenu)return void(t._selectedElement=e);t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(r,l),t._selectedElement=e,t.$.scrollableContainer.refresh()}}},{key:"_handleCustomOperations",value:function(){var e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions;for(var t=0;t<e.customOperations.length;t++){var a=e.customOperations[t];e._filterOperationDescriptions.push({label:a.label,value:a.name,custom:!0,index:t,editorTemplate:a.editorTemplate,valueTemplate:a.valueTemplate,handleValue:a.handleValue})}}},{key:"_initializeEditor",value:function(e){var t=this,a="jqx-"+JQX.Utilities.Core.toDash(e),i=document.createElement(a);"numericTextBox"===e?(i.spinButtons=!0,i.inputFormat="floatingPoint"):"dateTimePicker"===e&&(i.calendarButton=!0,i.dropDownDisplayMode="auto",i.enableMouseWheelAction=!0,i.locale=t.locale,i.messages[t.locale]||(i.messages[t.locale]={}),i.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),i.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),i.tabIndex="1",i.theme=t.theme,i.animation=t.animation,t.$[e+"Editor"]=i,i.$=JQX.Utilities.Extend(i),i.className=a+"-editor jqx-hidden",t.$.editorsContainer.appendChild(i),t["_"+e+"Initialized"]=!0}},{key:"_innerContainerKeydownHandler",value:function(e){var t=this;"Escape"!==e.key&&"Enter"!==e.key||!t._editorIsOpen||t._closeEditor()}},{key:"_inputBlurHandler",value:function(){var e=this,t=void 0;if(e._editor===e.$.dateTimePickerEditor)(t=e._editor.value)&&(t=t.toDate());else if(e._editor===e.$.checkBoxEditor)t=e._editor.checked;else if(e._editor===e.$.customEditor)t=e._selectedCustomCondition.handleValue(e._editor);else{var a=e._getFieldByFieldName(e._editedItem.data[0]);t="array"===a.dataType?e._editor.value.split(","):"object"===a.dataType?JSON.parse(e._editor.value):e._editor.value}var i=e._editedItem,n=i.nodeId,r=e._getFieldByFieldName(i.data[0]).dataType;e._updateValueInFlatArray(n,t,"value",r||"string"),e._generateValue()}},{key:"_localizeInitialValues",value:function(){var e=this,t=JQX.Utilities.DateTime.getLocalizedNames(e.locale);e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("notand"),value:"notand"},{label:e.localize("or"),value:"or"},{label:e.localize("notor"),value:"notor"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}],e._localizedDays=t.days,e._localizedMonths=t.months}},{key:"_mapFieldsToMenu",value:function(){var e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).map(function(e){var t={};return t.label=e.label,t.value=e.dataField,t.dataType=e.dataType,t}))}},{key:"_menuItemClickHandler",value:function(e){var t=this,a=t._selectedElement.closest(".filter-builder-item"),i=e.detail,n=i.value,r=t.localize(n)||i.label;if(a){var l=a.closest(".jqx-filter-group-condition"),o=a.closest(".jqx-filter-group"),d=l?l.getAttribute("node-id"):o.getAttribute("node-id"),s=2;if(a.innerHTML=r,a.value=n,t._editedItem&&a.classList.contains("jqx-filter-field-name")&&t._editedItem.data[0]!==n){var u=a.parentNode.querySelector(".jqx-filter-value"),c=t.customOperations.map(function(e){if(e.hideValue)return e.name}).filter(function(e){return e}),v=c.concat(["isblank","isnotblank"]);t._clearConditionsValue(d,n),t._setInitialFilterOperation(d,n),v.indexOf(n)>-1?u.classList.add("jqx-hidden"):u.classList.remove("jqx-hidden")}if(a.classList.contains("jqx-filter-field-name"))s=0;else if(a.classList.contains("jqx-filter-operation")){var p=a.parentNode.querySelector(".jqx-filter-value"),f=void 0;if(t.customOperations){var m=t.customOperations.filter(function(e){return e.name===n});m.length>0&&(f=m[0])}["isblank","isnotblank"].indexOf(n)>-1||f&&f.hideValue?(t._clearConditionsValue(d),p.classList.add("jqx-hidden")):p.classList.remove("jqx-hidden"),s=1}else if(a.classList.contains("jqx-filter-group-operation")){for(var _=0;_<t._valueFlat.length;_++)t._valueFlat[_].nodeId===d&&(t._valueFlat[_].data=a.value);return t._generateValue(),void t.$.scrollableContainer.refresh()}for(var h=0;h<t._valueFlat.length;h++)t._valueFlat[h].nodeId===d&&(t._valueFlat[h].data[s]=a.value);return t._generateValue(),void t.$.scrollableContainer.refresh()}var g=t._selectedElement.closest(".jqx-filter-group"),b=g.getAttribute("node-id");if(!t._isMaxLevelExceeded(b+".0")){if("addCondition"===n&&(t.maxConditions&&t._totalConditions<t.maxConditions||!t.maxConditions)){t._checkFieldsExistence();var y=t.fields?t.fields[0]:t._valueFields[0],x=y.filterOperations&&y.filterOperations.length>0?y.filterOperations[0]:"=";t._addElement("condition",b,[y.dataField,x,t._defaultValueByType(y.dataType)])}else"addGroup"===n&&t._addElement("group",b,"and");t.$.scrollableContainer.refresh()}}},{key:"_setInitialFilterOperation",value:function(e,t){var a=this,i=a.fields.find(function(e){return e.dataField===t}),n=a._valueFlat.find(function(t){return t.nodeId===e}),r=n.htmlNode.getElementsByClassName("jqx-filter-operation")[0],l=i&&i.filterOperations&&i.filterOperations.length>0?i.filterOperations[0]:"=",o=a.localize(l);o||(o=a.customOperations.find(function(e){return e.name===l}).label),n.data[1]=l,r.innerHTML=o}},{key:"_checkFieldsExistence",value:function(){var e=this;e.fields&&0!==e.fields.length||e._valueFields&&0!==e._valueFields.length||e.error(e.localize("missingFields",{elementType:e.nodeName.toLowerCase()}))}},{key:"_newFilterConditionRow",value:function(e){e=e||[];var t=this,a=e[0]?e[0]:t.fields[0].dataField,i=t._formatValueStringRepresentation(e[2],e[0]),n=t.fields?t.fields.filter(function(e){return e.dataField===a}):t._valueFields.filter(function(e){return e.dataField===a}),r=n.length>0?n[0].label:e[0],l=t.localize(e[1]);!l&&t.customOperations&&t.customOperations.length>0&&(l=t.customOperations.find(function(t){return t.name===e[1]}).label);var o=document.createElement("div"),d='<span class ="jqx-filter-delete-btn"></span>\n                <span class ="filter-builder-item jqx-filter-field-name">'+r+'</span>\n                <span class ="filter-builder-item jqx-filter-operation">'+(l||"")+'</span>\n                <span class ="filter-builder-item jqx-filter-value"><span class ="jqx-value-container">'+i+"</span></span>";return o.className="jqx-filter-group-condition",o.innerHTML=d,o}},{key:"_openEditor",value:function(e){var t=this,a=e&&e.closest(".jqx-filter-group-condition")?e.closest(".jqx-filter-group-condition").getAttribute("node-id"):null,i=e.closest(".jqx-filter-value"),n=t._getItemById(a),r=n.data[0]||t.fields[0].dataField||t._valueFields[0].dataField,l=t._getFieldByFieldName(r),o=void 0;if(n?void 0===(o=n.data[2])&&(o=""):o="",l){t._editorIsOpen&&t._closeEditor(),t.$.conditionsMenu.opened&&t.$.conditionsMenu.close(),i.setAttribute("edited",""),t._editedItem=n;var d=t.fields||t._valueFields,s=d.filter(function(e){return e.dataField===r}),u=t._filterOperationDescriptions.filter(function(e){return e.value===n.data[1]&&e.custom}),c=s.length>0?s[0]:null,v=l.lookup&&l.lookup.dataSource?"lookup":c.dataType;0!==u.length&&u[0].editorTemplate?(t._selectedCustomCondition=u[0],t._openCustomEditor(v,o,l)):t._openEditorByFieldType(v,o,l),t.$.fireEvent("editorOpening",{value:o,type:v,editedItem:n}),setTimeout(function(){t._editor.focus(),t._editor!==t.$.numericTextBoxEditor&&t._editor!==t.$.textBoxEditor||(t.$.scrollableContainer.scrollLeft=t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft,t.$.scrollableContainer.scrollTop=t.$.scrollableContainer.$.scrollViewerContainer.oldTop,t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft=0,t.$.scrollableContainer.$.scrollViewerContainer.scrollTop=0,t._editor.$.input.selectionStart=t._editor.$.input.selectionEnd=t._editor.$.input.value.length),t.$.scrollableContainer.refresh(),t.$.fireEvent("editorOpen",{value:o,type:v,editedItem:n})},0),t._editor.classList.remove("jqx-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),i.appendChild(t.$.editorsContainer),t.$.scrollableContainer.refresh()}}},{key:"_openEditorByFieldType",value:function(e,t,a){var i=this;switch(e){case"lookup":i._comboBoxInitialized||i._initializeEditor("comboBox"),i._editor=i.$.comboBoxEditor,i._editor.dataSource=a.lookup.dataSource,i._editor.dropDownAppendTo=i.$.container,i._editor.selectedValues=[t];break;case"boolean":i._checkBoxInitialized||i._initializeEditor("checkBox"),i._editor=i.$.checkBoxEditor,i._editor.checked=!!t;break;case"datetime":i._dateTimePickerInitialized||i._initializeEditor("dateTimePicker"),i._editor=i.$.dateTimePickerEditor,i._editor.formatString=i.formatStringDateTime,i._editor.dropDownAppendTo=i.$.container,i._editor.value=t;break;case"date":i._dateTimePickerInitialized||i._initializeEditor("dateTimePicker"),i._editor=i.$.dateTimePickerEditor,i._editor.formatString=i.formatStringDate,i._editor.dropDownAppendTo=i.$.container,i._editor.value=t;break;case"number":i._numericTextBoxInitialized||i._initializeEditor("numericTextBox"),t=t||0,i._editor=i.$.numericTextBoxEditor,i._editor.value=t;break;case"array":i._textBoxInitialized||i._initializeEditor("textBox"),i._editor=i.$.textBoxEditor,i._editor.value=t.toString();break;case"object":i._textBoxInitialized||i._initializeEditor("textBox"),t=t||{},i._editor=i.$.textBoxEditor,i._editor.value=JSON.stringify(t);break;default:i._textBoxInitialized||i._initializeEditor("textBox"),i._editor=i.$.textBoxEditor,i._editor.value=t+""}}},{key:"_openCustomEditor",value:function(e,t,a){var i=this,n=i.customOperations[i._selectedCustomCondition.index].editorTemplate(e,t,a);i.$.customEditor.innerHTML="",n&&i.$.customEditor.appendChild(n),i._editor=i.$.customEditor}},{key:"_refresh",value:function(){var e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e.$.scrollableContainer.refresh()}},{key:"_resizeHandler",value:function(){this.$.scrollableContainer.refresh()}},{key:"_scrollViewerWheelHandler",value:function(e){var t=this;"wheel"===e.type&&t.$.scrollableContainer.scrollHeight&&(e.stopPropagation(),e.preventDefault())}},{key:"_setInitialValues",value:function(){var e=this;e._mapFieldsToMenu(),e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}},{key:"_updatePlaceholder",value:function(){for(var e=this,t=0;t<e._valueFlat.length;t++){var a=e._valueFlat[t];"condition"!==a.type||null!==a.data[2]&&""!==a.data[2]||(a.htmlNode.querySelector(".jqx-value-container").innerHTML=e.valuePlaceholder)}
e.$.textBoxEditor&&(e.$.textBoxEditor.placeholder=e.valuePlaceholder)}},{key:"_updateValueInFlatArray",value:function(e,t,a,i){var n=this;if(e&&!n.disabled){if(i=i||"string",a=a||"value",null!==t)switch(i){case"number":t=parseFloat(t);break;case"boolean":t=!!t;break;case"string":t+=""}for(var r=0;r<n._valueFlat.length;r++)if(n._valueFlat[r].nodeId===e)switch(a){case"column":n._valueFlat[r].data[0]=t;break;case"filterCondition":n._valueFlat[r].data[1]=t;break;case"value":n._valueFlat[r].data[2]=t;break;case"groupCondition":n._valueFlat[r].data=t}}}},{key:"_validateNode",value:function(e,t){var a=this,i=void 0;return e instanceof HTMLElement?i=a._getItemById(e.getAttribute("node-id")):"string"==typeof e?i=a._getItemById(e):a.error(a.localize("wrongElementNode",{elementType:a.nodeName.toLowerCase(),method:t})),i||a.error(a.localize("wrongElementNode",{elementType:a.nodeName.toLowerCase(),method:t})),i}},{key:"_validateUserData",value:function(e,t){var a=this;if(t)(!Array.isArray(e)||e.length<3)&&a.error(a.localize("invalidDataStructure",{elementType:a.nodeName.toLowerCase()}));else{var i=/^(and|or|notAnd|notOr)$/i;"string"==typeof e&&e.match(i)||a.error(a.localize("invalidDataStructure",{elementType:a.nodeName.toLowerCase()}))}}},{key:"_validateValue",value:function(){function e(e){return 3===e.length&&"string"==typeof e[0]&&"string"==typeof e[1]}function t(a,o,d){var s=0;a.forEach(function(a){if(Array.isArray(a))if(e(a)){if(null!==i&&i===l||null!==n&&n===s)return;d.push(a),s++,l++}else{if(null!==r&&r===o+1)return;var u=[];d.push(u),t(a,o+1,u)}else d.push(a)})}var a=this,i=a.maxConditions,n=a.maxConditionsPerGroup,r=a.maxLevel,l=0;if(null!==i||null!==n||null!==r){var o=a.value,d=[];t(o,0,d),a.value=d}}}],[{key:"properties",get:function(){return{customOperations:{value:[],type:"array",reflectToAttribute:!1},disableContextMenu:{value:!1,type:"boolean"},fields:{value:null,type:"array?",reflectToAttribute:!1},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},hint:{value:null,type:"string?"},icons:{value:{"=":"=","<>":"≠",">":">",">=":"≥","<":"<","<=":"≤",startswith:"a|bc",endswith:"ab|c",contains:"abc",notcontains:"!abc",isblank:"○",isnotblank:"●"},type:"object",reflectToAttribute:!1},maxConditions:{value:null,type:"number?",validator:"_maxValidator"},maxConditionsPerGroup:{value:null,type:"number?",validator:"_maxValidator"},maxLevel:{value:null,type:"number?",validator:"_maxValidator"},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:'{{elementType}}: Wrong parent group index in "{{method}}" method.',missingFields:'{{elementType}}: Fields are required for proper condition\'s adding. Set "fields" source and then conditions will be added as expected.',wrongElementNode:'{{elementType}}: Incorect node / node Id in "{{method}}" method.',invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME"}},type:"object",extend:!0},restrictedMode:{value:!1,type:"boolean"},showIcons:{value:!1,type:"boolean"},value:{value:["or"],type:"array?",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"&lt;enter a value&gt;",type:"string"}}}},{key:"requires",get:function(){return{"JQX.Button":"jqxbutton.js","JQX.CheckBox":"jqxcheckbox.js","JQX.ScrollBar":"jqxscrollbar.js","JQX.ListBox":"jqxlistbox.js","JQX.DropDownList":"jqxdropdownlist.js","JQX.ComboBox":"jqxcombobox.js","JQX.Calendar":"jqxcalendar.js","JQX.TimePicker":"jqxtimepicker.js","JQX.Tooltip":"jqxtooltip.js","JQX.Utilities.DateTime":"jqxdate.js","JQX.DateTimePicker":"jqxdatetimepicker.js","JQX.Menu":"jqxmenu.js"}}},{key:"listeners",get:function(){return{down:"_downHandler","document.click":"_documentClickHandler","conditionsMenu.itemClick":"_menuItemClickHandler","container.change":"_containerChangeHandler","scrollableContainer.wheel":"_scrollViewerWheelHandler","scrollableOuterContainer.resize":"_resizeHandler","innerContainer.keydown":"_innerContainerKeydownHandler"}}},{key:"styleUrls",get:function(){return["jqx.filterbuilder.css"]}}]),t}(JQX.BaseElement)),JQX("jqx-query-builder",function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"template",value:function(){return'<div id="container">\n                    <jqx-scroll-viewer id="scrollableContainer" class ="jqx-scrollable-container" animation="[[animation]]">\n                        <div id="queryLabel" class="jqx-query-builder-label jqx-unselectable"></div>\n                        <div id="contentContainer" class ="jqx-content-container"></div>\n                    </jqx-scroll-viewer>\n                    <div id="editorsContainer" class ="jqx-editors-container">\n                        <div id="customEditor" class ="jqx-custom-editor jqx-hidden"></div>\n                    </div>\n                    <jqx-menu id="conditionsMenu" mode="dropDown" class ="jqx-conditions-menu" theme="[[theme]]" animation="[[animation]]"></jqx-menu>\n                </div>'}},{key:"propertyChangedHandler",value:function(e,a,i){babelHelpers.get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"propertyChangedHandler",this).call(this,e,a,i);var n=this;switch(e){case"animation":case"theme":["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"].forEach(function(t){return n.$[t]&&(n.$[t][e]=i)});break;case"formatStringDate":case"formatStringDateTime":case"valueFormatFunction":n._refresh();break;case"operatorPlaceholder":Array.from((n.shadowRoot||n).querySelectorAll(".jqx-filter-operation[placeholder]")).forEach(function(e){return e.firstElementChild.innerHTML=i});break;case"propertyPlaceholder":Array.from((n.shadowRoot||n).querySelectorAll(".jqx-filter-field-name[placeholder]")).forEach(function(e){return e.firstElementChild.innerHTML=i});break;case"showIcons":n._closeEditor(),i?n._filterOperationDescriptions.map(function(e){return e.icon=n.icons[e.value]}):n._filterOperationDescriptions.map(function(e){return delete e.icon});break;case"customOperations":case"fields":case"value":var r=JSON.stringify(n._validValue);"customOperations"===e?n._handleCustomOperations():""===e&&n._mapFieldsToMenu(),n._applyValue(),n._oldValueAsString!==r&&(n._oldValueAsString=r,n.$.fireEvent("change",{value:JSON.parse(r)}));break;case"valuePlaceholder":Array.from((n.shadowRoot||n).querySelectorAll(".jqx-filter-value[placeholder]")).forEach(function(e){return e.firstElementChild.innerHTML=i});break;case"locale":case"messages":n._localizeInitialValues(),n._refresh(),n._handleCustomOperations(),n.$.dateTimePickerEditor&&(n.$.dateTimePickerEditor.messages[n.locale]||(n.$.dateTimePickerEditor.messages[n.locale]={}),n.$.dateTimePickerEditor.messages[n.locale].dateTabLabel=n.localize("dateTabLabel"),n.$.dateTimePickerEditor.messages[n.locale].timeTabLabel=n.localize("timeTabLabel"),"locale"===e?n.$.dateTimePickerEditor.locale=n.locale:"messages"===e&&(n.$.dateTimePickerEditor.$.selectDate.innerHTML=n.$.dateTimePickerEditor.messages[n.locale].dateTabLabel,n.$.dateTimePickerEditor.$.selectTime.innerHTML=n.$.dateTimePickerEditor.messages[n.locale].timeTabLabel));break;case"icons":n._closeEditor()}}},{key:"ready",value:function(){babelHelpers.get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"ready",this).call(this);var e=this;-1!==navigator.platform.toLowerCase().lastIndexOf("mac")&&e.$.contentContainer.classList.add("mac"),e._setInitialValues(),e._handleCustomOperations(),e._applyValue(),Object.defineProperty(e,"value",{get:function(){return e.context===e?e.properties.value.value:e._validValue},set:function(t){e.updateProperty(e,e._properties.value,t)}})}},{key:"_setInitialValues",value:function(){var e=this;e._autoScrollCoefficient=JQX.Utilities.Core.Browser.Firefox?4:JQX.Utilities.Core.Browser.Edge?8:2,e._isMobile=JQX.Utilities.Core.isMobile,e._manuallyAddedFields=[],e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}},{key:"_applyValue",value:function(){var e=this;e._emptyElementsStructure(!0),e._validateValue(),e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._mapFieldsToMenu(),e._generateHTMLStructureFromFlatValue(!0),e._restrictNesting(),e._validValue=e._getValidValue(),e._oldValueAsString=JSON.stringify(e._validValue)}},{key:"_setRequiredFields",value:function(){var e=this;if(e.requiredFields&&e.requiredFields.length){for(var t=e.value,a=[],i=0;i<e.requiredFields.length;i++)!function(i){var n=e.requiredFields[i],r=e.fields.find(function(e){return e.dataField===n});if(r){var l=[];if(t)for(var o=0;o<t.length;){var d=t[o];if(Array.isArray(d))for(var s=0;s<d.length;){var u=d[s];u&&u[0]===r.dataField?(l.push(u),d.splice(s>0?s-1:s,2)):s++}d.length?o++:t.splice(o,2)}if(l)for(var c=0;c<l.length;c++)a.push(l[c]),a.push("and");else a.push([n]),a.push("and")}}(i);"string"==typeof a[a.length-1]&&a.pop(),e.value.unshift(a,"and")}}},{key:"_contentContainerChangeHandler",value:function(e){var t=this;if(e.stopPropagation(),"immediately"===t.applyMode&&t._editorIsOpen&&t._editor){t._editor.closest(".filter-builder-item").classList.contains("jqx-filter-value")||t._closeEditor()}}},{key:"_mapFieldsToMenu",value:function(){var e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).concat(e._manuallyAddedFields).map(function(e){return{label:e.label,value:e.dataField,dataType:e.dataType,filterOperations:e.filterOperations,lookup:e.lookup}}))}},{key:"_localizeInitialValues",value:function(){var e=this;e.$.queryLabel.innerHTML=e.localize("queryLabel"),e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("or"),value:"or"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}];var t=JQX.Utilities.DateTime.getLocalizedNames(e.locale);e._localizedDays=t.days,e._localizedMonths=t.months}},{key:"_handleCustomOperations",value:function(){var e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions.slice(0);for(var t=0;t<e.customOperations.length;t++){var a=e.customOperations[t];e._filterOperationDescriptions.push({label:a.label,value:a.name,custom:!0,index:t,editorTemplate:a.editorTemplate,valueTemplate:a.valueTemplate,handleValue:a.handleValue,hideValue:a.hideValue})}}},{key:"_innerContainerKeydownHandler",value:function(e){var t=this;!t._editorIsOpen||"Escape"!==e.key&&"Enter"!==e.key||t._closeEditor()}},{key:"_documentDownHandler",value:function(e){var t=this,a=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(!(a.shadowParent&&a.shadowParent.closest(".jqx-input-drop-down-menu")||a.closest(".jqx-input-drop-down-menu")||t.$.conditionsMenu.contains(a))){var i=a.closest(".jqx-drop-down");if(a.getRootNode().host===t||a.closest("jqx-query-builder")===t||i&&t.contains(i.ownerElement))return void t._clickHandler(e.originalEvent);t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown}}},{key:"_emptyElementsStructure",value:function(e){for(var t=this,a=t.$.contentContainer;a.firstChild;)a.removeChild(a.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}},{key:"_resizeHandler",value:function(){this.$.scrollableContainer.refresh()}},{key:"_getTotalConditions",value:function(){return this.getElementsByClassName("jqx-filter-group-condition").length}},{key:"_validateValue",value:function(){var e=this,t=e.value;if(!Array.isArray(t)||""===JSON.stringify(t).replace(/[\[\]]/g,""))return void(e.value=[[[]]]);for(3===t.length&&"string"==typeof t[0]&&(e.value=[[t]]),Array.isArray(t[0])&&3===t[0].length&&"string"==typeof t[0][0]&&(e.value=[t]);"string"==typeof t[0];)t.shift();for(;"string"==typeof t[t.length-1];)t.pop();e.value.forEach(function(e){Array.isArray(e)&&0===e.length&&e.push([])})}},{key:"_convertValueToFlat",value:function(e){function t(e,l){for(var o=void 0,d=0;d<e.length;d++){var s=e[d],u="string"==typeof s&&i.indexOf(s)>-1,c={htmlNode:null};if(u)o=s.trim();else if(o=o||"and",Array.isArray(s)){var v=a._valueFlat.filter(function(e){return e.parentId+""==l+""}).length;if(s.find(function(e){return Array.isArray(e)}))c.nodeId=(r+=1)+"",c.type="group",c.data=o,a._valueFlat.push(c),t(s,c.nodeId),o="";else{if(a.maxConditions&&n>=a.maxConditions||a.maxConditionsPerGroup&&v>=a.maxConditionsPerGroup)continue;0!==d&&(a._valueFlat.push({nodeId:l+"."+v,type:"operator",data:o,parentId:l+""}),o="",v++),c.nodeId=l+"."+v,c.parentId=l+"",c.type="condition",c.data=s,n++,a._valueFlat.push(c)}}}}var a=this,i=["and","or","notAnd","notOr"];if(e){var n=0,r=0;a._valueFlat=[],t(e,0),delete a._totalGroups}}},{key:"_getFieldsFromValue",value:function(){for(var e=this,t=e._valueFlat,a=[],i=[],n=0;n<t.length;n++){var r=t[n];if("condition"===r.type){var l=r.data[0];if(l&&-1===a.indexOf(l)){var o={label:l,dataField:l,dataType:function(e){return"boolean"==typeof e?"boolean":e instanceof Date?e.getHours()>0||e.getMinutes()>0||e.getSeconds()>0?"datetime":"date":isNaN(e)?"string":"number"}(r.data[2]),format:null};a.push(l),i.push(o)}}}e._valueFields=i}},{key:"_addElement",value:function(e,t,a,i){var n=this,r=n._valueFlat.filter(function(e){return e.parentId===t}),l=0,o="";if(a=a||("group"===e?"or":[]),r.length){var d=r.map(function(e){var t=e.nodeId.split(".");return parseInt(t[t.length-1])});d=0===d.length?[0]:d,l=d.reduce(function(e,t){return Math.max(e,t)})+1}t&&t.length>0&&(o=".");var s=(t||"")+o+("group"===e?n._valueFlat.filter(function(e){return"group"===e.type}).length+1:l),u=r[0];if(r.length)for(var c=0;c<r.length;c++){var v=r[c],p=v.nodeId.split(".").pop();parseInt(p)>parseInt(u.nodeId.split(".").pop())&&(u=v)}else u=n._valueFlat.find(function(e){return e.nodeId===t});var f=u?n._valueFlat.indexOf(u)+1:n._valueFlat.length;"condition"===e&&r.length>0&&(n._valueFlat.splice(f,0,{nodeId:s,parentId:t,type:"operator",data:["and"],htmlNode:null}),s=(t||"")+o+(l+1),f++);var m={nodeId:s,parentId:t,type:e,data:a,htmlNode:null};n._valueFlat.splice(f,0,m),"group"===e&&n._addElement("condition",s,[],!0),i||n._refresh()}},{key:"_deleteElement",value:function(e,t){function a(e){var t=r._valueFlat[e];if(t&&"operator"===t.type)return r._valueFlat.splice(e,1),t.htmlNode.parentElement.removeChild(t.htmlNode),!0}function i(e){var t=void 0,i=0,n=e.split(".");n.pop(),n=n.join(".");for(var l=0;l<r._valueFlat.length;l++){var o=r._valueFlat[l];if("condition"===o.type){if(o.nodeId===e){t=o;break}o.parentId===n&&i++}}var d=r._valueFlat.indexOf(t);r._valueFlat.splice(d,1),t.htmlNode.parentElement.removeChild(t.htmlNode);var s=a(d-1);i||a(d-(s?1:0));var u=r._valueFlat.filter(function(e){return e.nodeId===n})[0].htmlNode;u.children[1].childElementCount>0&&u.children[2].hasAttribute("limit-selection")&&!u.children[1].lastElementChild.hasAttribute("limit-selection")&&u.children[2].removeAttribute("limit-selection")}function n(e){for(var t=r._valueFlat.filter(function(t){return e===t.nodeId&&"group"===t.type})[0],a=0;a<r._valueFlat.length;a++){var l=r._valueFlat[a],o=l.nodeId;l.parentId===e&&("group"===l.type?n(o):i(o))}r._valueFlat.indexOf(t)>-1&&r._valueFlat.splice(r._valueFlat.indexOf(t),1),t.htmlNode.parentElement.removeChild(t.htmlNode)}var r=this,l="string"==typeof e?e:e.getAttribute("node-id");if(l&&1!==l.length&&("group"===t?n(l):i(l),!t||"condition"===t)){var o=l.split(".");if(o.pop(),o=o.join("."),!r._valueFlat.filter(function(e){return e.parentId===o}).length&&(r._valueFlat.filter(function(e){return"group"===e.type}).length>1&&n(o),"0"===o)){var d=r._valueFlat.find(function(e){return"group"===e.type}),s=d.nodeId;d.nodeId="0",d.htmlNode.setAttribute("node-id","0");for(var u=r._valueFlat.filter(function(e){return e.parentId===s}),c=0;c<u.length;c++){var v=u[c];v.parentId="0",v.nodeId="0."+c,v.htmlNode.setAttribute("node-id",v.nodeId)}}r._generateValue()}}},{key:"_generateHTMLStructureFromFlatValue",value:function(e){var t=this,a=document.createDocumentFragment();if(t._valueFlat&&0!==t._valueFlat.length){for(var i=0;i<t._valueFlat.length;i++)!function(e){var i=t._valueFlat[e],n=!!t.customOperations&&t.customOperations.find(function(e){return e.name===i.data[1]}),r=i.parentId?(t.shadowRoot||t).querySelector('[node-id="'+i.parentId+'"]').querySelector(".jqx-filter-group-condition-container"):t.$.contentContainer;if("group"===i.type){var l=document.createElement("div"),o=t.localize(i.data)||"";l.className="jqx-filter-group",l.innerHTML='<div class="jqx-filter-group-operator">'+o+'</div><div class="jqx-filter-group-condition-container"></div><div class="jqx-filter-add-condition-btn"><div>'+t.localize("add")+'</div></div><div class="jqx-filter-add-btn"></div>',l.firstElementChild.data=o,a.appendChild(l),l.setAttribute("node-id",i.nodeId),t._valueFlat[e].htmlNode=l}else if("condition"===i.type){var d=t._newFilterConditionRow(i.data);if(d.setAttribute("node-id",i.nodeId),a.appendChild(d),t._valueFlat[e].htmlNode=d,void 0!==i.data[0]&&void 0===i.data[1]){var s=t._getFilterOperations(t._fields.find(function(e){return e.value===i.data[0]}));t._handleOnlyOperation(s,i.data,d)}else(-1!==["isblank","isnotblank"].indexOf(i.data[1])||n&&n.hideValue)&&(i.data.splice(2,1),d.children[2].classList.add("jqx-visibility-hidden"))}else{var u=document.createElement("div");u.className="jqx-filter-nested-operator",u.setAttribute("node-id",i.nodeId),u.innerHTML=t.localize(i.data),a.appendChild(u),t._valueFlat[e].htmlNode=u}r.appendChild(a)}(i);e&&t._validateValueAdvanced(),t.$.scrollableContainer.refresh()}}},{key:"_validateValueAdvanced",value:function(){for(var e=this,t=e.value,a=!1,i=!1,n=0,r=0;r<t.length;r++){var l=t[r];if("string"!=typeof l)for(var o=l.length-1;o>=0;o--){var d=l[o];if(Array.isArray(d)&&0===d.length&&o!==l.length-1)l.splice(o,1),0===o&&l.splice(0,1),a=!0;else if("string"==typeof d){d=d.toLowerCase(),n++,(n>1||"and"!==d&&"or"!==d)&&(i=!0);continue}n=0}}a&&(e._emptyElementsStructure(!0),e._convertValueToFlat(e.value),e._generateHTMLStructureFromFlatValue()),i&&e._generateValue(!0)}},{key:"_restrictNesting",value:function(){var e=this;Array.from(e.getElementsByClassName("jqx-filter-add-condition-btn")).forEach(function(e){var t=e.previousElementSibling.lastElementChild;t&&t.hasAttribute("limit-selection")&&e.setAttribute("limit-selection","")})}},{key:"_clickHandler",value:function(e){var t=this,a=t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target;if(!t.disabled&&a&&a.closest&&(t._isMobile||0===e.button)){if(t._scrollBarDown)return void delete t._scrollBarDown;var i=a.closest(".jqx-drop-down"),n=t._editor&&t._editor.contains(a)||i&&(t._editor.contains(i.ownerElement)||t._editor===i.ownerElement)||a.closest(".jqx-custom-editor");t._editor&&t._editorIsOpen&&!n&&t._closeEditor();var r=a.closest(".jqx-filter-group-condition")||a.closest(".jqx-filter-nested-operator")||a.closest(".jqx-filter-group");if(r){var l=t._getItemById(r.getAttribute("node-id"));if(l){if(t.$.fireEvent("itemClick",{id:l.nodeId,type:l.type,data:l.data}),a.closest(".jqx-filter-delete-btn"))return void t._clickHandlerDeleteButton(l.htmlNode);var o=a.closest(".jqx-filter-add-btn")||a.closest(".jqx-filter-add-condition-btn");if(o){var d=o.closest(".jqx-filter-group").getAttribute("node-id");return void(o.classList.contains("jqx-filter-add-condition-btn")&&(t.maxConditions&&t._getTotalConditions()<t.maxConditions||!t.maxConditions)?t._addElement("condition",d,[]):t._clickHandlerFilterButton(o.classList,l.nodeId,a))}var s=a.closest(".filter-builder-item")||a.closest(".jqx-filter-group-operator")||a.closest(".jqx-filter-nested-operator");if(s){var u=s.classList;t._clickHandlerFilterButton(u,l.nodeId,a)}}}}}},{key:"_downHandler",value:function(e){var t=this;if(e.originalEvent&&(t._isMobile||0===e.button)){var a=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(t.allowDrag&&a.classList.contains("jqx-filter-group-condition")&&e.pageX<a.getBoundingClientRect().left){var i=t._valueFlat.filter(function(e){return"condition"===e.type});if(1===i.length||2===i.length&&i[0].parentId===i[1].parentId&&i[1].htmlNode.hasAttribute("limit-selection"))return;return t._dragDetails={coords:{x:e.pageX,y:e.pageY},item:a,originalEvent:e},t.$.scrollableContainer._scrollView.disableSwipeScroll=!0,t._hoveredCondition=a,void window.getSelection().removeAllRanges()}this._scrollBarDown=a.closest("jqx-scroll-bar"),e.stopPropagation(),e.preventDefault()}}},{key:"_moveHandler",value:function(e){"touchmove"===e.originalEvent.type&&e.originalEvent.preventDefault()}},{key:"_documentMoveHandler",value:function(e){var t=this,a=t._dragDetails;if(a){var i=a.item;if(!a.feedbackShown){if(!(Math.abs(a.coords.x-e.pageX)>5||Math.abs(a.coords.y-e.pageY)>5))return;var n=t._valueFlat.filter(function(e){return e.htmlNode===i})[0];if(t.$.fireEvent("dragStart",{data:n.data,item:i,originalEvent:e}).defaultPrevented)return delete t._dragDetails,delete t._hoveredCondition,void(t.$.scrollableContainer._scrollView.disableSwipeScroll=!1);a.allConditions=Array.from((t.shadowRoot||t).querySelectorAll(".jqx-filter-group-condition")),a.data=n,a.feedback=t._addDragFeedback(),a.feedbackShown=!0,i.classList.add("dragged")}var r=e.clientY,l=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target,o=void 0;if(t.$.fireEvent("dragging",{data:a.data,item:i,originalEvent:e}),t.setAttribute("dragging",""),a.feedback.style.left=e.pageX+10+"px",a.feedback.style.top=e.pageY+10+"px",t._isMobile){var d=t._hoveredCondition;d&&(d.classList.remove("drop-target","top","bottom"),delete t._hoveredCondition);var s=document.elementFromPoint(e.clientX,r);s&&(l=s)}var u=l.closest(".jqx-filter-group-condition"),c=void 0;if(u){o=u;var v=o.getBoundingClientRect(),p=Math.abs(r-v.top),f=Math.abs(r-v.bottom);c=p<f?"top":"bottom"}else{var m=void 0,_=void 0;a.allConditions.forEach(function(e){var t=e.getBoundingClientRect(),a=Math.abs(r-t.top),i=Math.abs(r-t.bottom),n=Math.min(a,i);(void 0===_||n<_)&&(m=e,_=n,c=a<i?"top":"bottom")}),u=m}if(u===i||u.hasAttribute("limit-selection")&&"bottom"===c)u=void 0;else{var h=Array.from(u.parentElement.getElementsByClassName("jqx-filter-group-condition")),g=h.indexOf(i);-1!==g&&("top"===c&&u===h[g+1]||"bottom"===c&&u===h[g-1])&&(u=void 0)}if(o=u,a.side=c,clearInterval(t._dragInterval),t._dragInterval=setInterval(function(){var a=t.getBoundingClientRect();t.$.scrollableContainer.scrollHeight>0&&a.left<=e.clientX&&a.left+a.width>=e.clientX?r>=a.top&&r<=a.top+36?t.$.scrollableContainer.scrollTop-=t._autoScrollCoefficient:r>=a.top+a.height-36&&r<=a.top+a.height?t.$.scrollableContainer.scrollTop+=t._autoScrollCoefficient:clearInterval(t._dragInterval):clearInterval(t._dragInterval)},1),o){t._hoveredCondition&&o!==t._hoveredCondition&&t._hoveredCondition.classList.remove("drop-target","top","bottom");var b=o.closest(".jqx-filter-group");if(b&&b.hasAttribute("restricted"))return void(t._hoveredCondition=void 0);t._hoveredCondition=o,o.classList.remove("top","bottom"),o.classList.add(c,"drop-target")}else t._hoveredCondition&&(t._hoveredCondition.classList.remove("drop-target","top","bottom"),delete t._hoveredCondition)}}},{key:"_addDragFeedback",value:function(){var e=document.createElement("div");return e.className="jqx-query-builder-drag-feedback",document.body.appendChild(e),e}},{key:"_documentUpHandler",value:function(e){var t=this,a=t._dragDetails;if(!a)return void(t.$.conditionsMenu.opened&&t._selectedElement&&!t._selectedElement.classList.contains("jqx-filter-add-btn")&&t.$.conditionsMenu._hoverViaKeyboard(t.$.conditionsMenu.querySelector('jqx-menu-item[value="'+t._editedItem.data+'"]')));var i=a.item,n=a.data,r=t._hoveredCondition;if(delete t._dragDetails,delete t._hoveredCondition,t.$.scrollableContainer._scrollView.disableSwipeScroll=!1,t.hasAttribute("dragging")){if(clearInterval(t._dragInterval),window.getSelection().removeAllRanges(),t.removeAttribute("dragging"),i.classList.remove("dragged"),document.body.removeChild(a.feedback),!r)return void t.$.fireEvent("dragEnd",{data:n.data,item:i,originalEvent:e,target:null,targetData:null,targetSide:null});var l=t._valueFlat.filter(function(e){return e.htmlNode===r})[0],o=t.$.fireEvent("dragEnd",{data:n.data,item:i,originalEvent:e,target:r,targetData:l.data,targetSide:a.side});if(r.classList.remove("drop-target","top","bottom"),!o.defaultPrevented){var d=t.value,s=n.nodeId.split(".").map(function(e){return parseFloat(e)}),u=d[2*(s[0]-1)],c=l.nodeId.split(".").map(function(e){return parseFloat(e)}),v=d[2*(c[0]-1)],p="and";u.length>1&&(0===s[1]?(p=u[1],u[1]="!remove!"):(p=u[s[1]-1],u[s[1]-1]="!remove!")),u[s[1]]="!remove!","top"===a.side?v.splice(c[1],0,n.data,p):v.splice(c[1]+1,0,p,n.data);for(var f=0;f<d.length;f++)Array.isArray(d[f])&&(d[f]=d[f].filter(function(e){return"!remove!"!==e}));for(var m=d.length-1;m>=0;m--)Array.isArray(d[m])&&0===d[m].length&&(0===m?d.splice(0,2):(d.splice(m-1,2),m--));t._emptyElementsStructure(!0),t._convertValueToFlat(d),t._generateHTMLStructureFromFlatValue(),t._validValue=t._getValidValue();var _=JSON.stringify(t._validValue);t._oldValueAsString!==_&&(t._oldValueAsString=_,t.$.fireEvent("change",{value:JSON.parse(_)}))}}}},{key:"_clickHandlerDeleteButton",value:function(e,t){var a=this;if(e&&e.classList){if(a._closeEditor(),1===a.getElementsByClassName("jqx-filter-group-condition").length){var i=a._valueFlat[1].htmlNode.children;a.value=[[[]]],a._validValue=a._getValidValue(),a._valueFlat[1].data=[],a._valueFlat[1].htmlNode.setAttribute("limit-selection",""),i[0].setAttribute("placeholder",""),i[1].setAttribute("placeholder",""),i[2].setAttribute("placeholder",""),i[0].firstElementChild.innerHTML=a.propertyPlaceholder,i[1].firstElementChild.innerHTML=a.operatorPlaceholder,i[2].firstElementChild.innerHTML=a.valuePlaceholder;var n=JSON.stringify(a._validValue);return void(a._oldValueAsString!==n&&(a._oldValueAsString=n,a.$.fireEvent("change",{value:JSON.parse(n)})))}if(e.classList.contains("jqx-filter-group")){if(t&&a._valueFlat.filter(function(t){return t.parentId===e.getAttribute("node-id")}).length>0)return;a._deleteElement(e,"group")}else a._deleteElement(e);a._generateValue(),a.$.scrollableContainer.refresh(),Array.from(a.$.contentContainer.children).forEach(function(e,t){var i=(t+1).toString();e.setAttribute("node-id",i),a._valueFlat.filter(function(t){return t.htmlNode===e})[0].nodeId=i,Array.from(e.children[1].children).forEach(function(e,t){var n=a._valueFlat.filter(function(t){return t.htmlNode===e})[0],r=i+"."+t;e.setAttribute("node-id",r),n.parentId=i,n.nodeId=r})})}}},{key:"_menuClosingHandler",value:function(e){var t=e.detail;"interaction"===t.trigger&&this._selectedElement===t.target&&e.preventDefault()}},{key:"_menuItemClickHandler",value:function(e){var t=this,a=t._selectedElement.closest(".jqx-filter-group-operator, .jqx-filter-nested-operator"),i=e.detail,n=i.value,r=void 0;if(a){a.innerHTML=t.localize(n)||i.label,a.value=n,r=a.classList.contains("jqx-filter-nested-operator")?a.getAttribute("node-id"):a.parentElement.getAttribute("node-id");for(var l=0;l<t._valueFlat.length;l++)if(t._valueFlat[l].nodeId===r){t._valueFlat[l].data=a.value;break}t._generateValue()}else r=t._selectedElement.parentElement.getAttribute("node-id"),t._addElement("group",null,n);t.$.scrollableContainer.refresh()}},{key:"_newFilterConditionRow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this,a=e[0],i=t._fields.find(function(e){return e.value===a}),n=i?i.label:void 0,r=void 0;if(void 0===a||!n&&"static"===t.fieldsMode)e.length=0;else{n||(i=t._getDynamicFieldInfo(a),n=i.label,e[0]=i.dataField);r=t._getFilterOperations(i).find(function(t){return t.value===e[1]}),r?r=r.label:e.splice(1,2)}var l=t._formatValueStringRepresentation(e[2],e[0],e[1]),o=document.createElement("div"),d='<div class ="filter-builder-item jqx-filter-field-name" '+(n?'><div class ="jqx-value-container">'+n:'placeholder><div class ="jqx-value-container">'+t.propertyPlaceholder)+'</div></div><div class ="filter-builder-item jqx-filter-operation" '+(r?'><div class ="jqx-value-container">'+r:'placeholder><div class ="jqx-value-container">'+t.operatorPlaceholder)+'</div></div><div class ="filter-builder-item jqx-filter-value" '+(void 0!==e[2]?'><div class ="jqx-value-container">'+l:'placeholder><div class ="jqx-value-container">'+t.valuePlaceholder)+'</div></div><div class ="jqx-filter-delete-btn"></div>';return o.className="jqx-filter-group-condition",o.innerHTML=d,e.length||o.setAttribute("limit-selection",""),o}},{key:"_formatValueStringRepresentation",value:function(e,t,a){var i=this,n=i._getFieldByFieldName(t),r=void 0;if(!n)return e;if(void 0===e||null===e)return i.valuePlaceholder;if(void 0!==a&&i.customOperations&&i.customOperations.length>0&&(a=i.customOperations.find(function(e){return e.name===a}))&&a.valueTemplate)return a.valueTemplate(i._editor,e);switch(n.dataType){case"date":case"datetime":e=e instanceof Date||"string"==typeof e||"number"==typeof e&&!isNaN(e)?new JQX.Utilities.DateTime(e):e,e.calendar.days=i._localizedDays,e.calendar.months=i._localizedMonths,e.calendar.locale=i.locale,r=e.toString("date"===n.dataType?i.formatStringDate:i.formatStringDateTime);break;case"array":r="string"==typeof e?e.split(","):e;break;case"object":r="string"==typeof e?e:JSON.stringify(e);break;case"number":r=e;break;case"boolean":r=!!e;break;default:r=e+""}return i.valueFormatFunction?i.valueFormatFunction(r,t,n.dataType||"string"):r}},{key:"_getFieldByFieldName",value:function(e){return Object.assign({},this._fields.find(function(t){return t.value===e}))}},{key:"_refresh",value:function(){var e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e._restrictNesting()}},{key:"_generateValue",value:function(e){for(var t=this,a=[],i=t._valueFlat.slice(0),n=[],r=0;r<i.length;r++){var l=i[r],o={};"group"===l.type&&(o.nodeId=l.nodeId,o.parentId=l.parentId,o.data=l.data,o.structure=[],a.push(o))}for(var d=0;d<a.length;d++)for(var s=a[d],u=0;u<i.length;u++){var c=i[u];if(c.parentId===s.nodeId&&"condition"===c.type){var v=i[u-1];v&&v.parentId===s.nodeId&&"operator"===v.type&&s.structure.push(v.data.toString()),s.structure.push(c.data)}}a=a.filter(function(e){return e.structure.length>0}),a.sort(function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length});for(var p=0;p<a.length;p++){(function(e){var t=a[e],i=a.filter(function(e){return e.nodeId===t.parentId})[0];i&&i.structure?i.structure.push(t.structure):"0"===t.nodeId?n=n.concat(t.structure):t.data&&(e>0&&n.push(t.data),
n.push(t.structure))})(p)}if(t.value=n,t._validateValue(),t._validValue=t._getValidValue(),!e){var f=JSON.stringify(t._validValue);t._oldValueAsString!==f&&(t._oldValueAsString=f,t.$.fireEvent("change",{value:JSON.parse(f)}))}}},{key:"_getItemById",value:function(e,t){var a=this,i=a._valueFlat.filter(function(a){return t?a.parentId===e:a.nodeId===e});return i.length>0?i[0]:null}},{key:"_closeEditor",value:function(e){var t=this,a=void 0;if(t._editedItem&&t._editorIsOpen){var i=t._editedItem,n=t._editor.closest(".filter-builder-item"),r=n.querySelector(".jqx-value-container"),l=n.parentElement,o=l.children[2];if(t._editor===t.$.dateTimePickerEditor)(a=t._editor.value)&&(a=a.toDate());else if(t._editor===t.$.checkBoxEditor)a=t._editor.checked;else if(t._editor===t.$.customEditor){if(t._editor){var d=Array.from(t._editor.getElementsByTagName("jqx-numeric-text-box"));d.forEach(function(e){return e._inputBlurHandler()})}a=t._selectedCustomCondition.handleValue(t._editor)}else if(t._editor===t.$.numericTextBoxEditor)t._editor._inputBlurHandler(),a=t._editor.value;else if(n.classList.contains("jqx-filter-value")){var s=t._getFieldByFieldName(t._editedItem.data[0]);a="array"===s.dataType?t._editor.value.split(","):"object"===s.dataType?JSON.parse(t._editor.value):t._editor.value}else a=t._editor.value;if(n.classList.contains("jqx-filter-field-name")){if(""===a.trim())return void t._hideEditor(n,void 0===i.data[0]);l.hasAttribute("limit-selection")&&(l.removeAttribute("limit-selection"),l.parentElement.nextElementSibling.removeAttribute("limit-selection"));var u=t._fields.find(function(e){return e.label===a}),c=i.data[0];if(u)i.data[0]=u.value;else{if("dynamic"!==t.fieldsMode)return r.innerHTML=t._fields.find(function(e){return e.value===c}).label,void t._hideEditor(n);var v=t._getDynamicFieldInfo(a);a=v.label,i.data[0]=v.dataField}r.innerHTML=a,t._handleFieldChange([c,i.data[0]],[o,i,l])}else n.classList.contains("jqx-filter-operation")?t._handleOperationChange([i,a,t._editor.$.input.dataValue],[r,o]):(i.data[2]=a,r.innerHTML=t._formatValueStringRepresentation(a,t._editedItem.data[0],t._editedItem.data[1]));t._generateValue(e),t._hideEditor(n)}}},{key:"_getDynamicFieldInfo",value:function(e){var t=this,a={label:e,dataField:e,dataType:"string"};if(t.getDynamicField){var i=t.getDynamicField(e);i.label&&(a.label=i.label),i.dataField&&(a.dataField=i.dataField),i.dataType&&(a.dataType=i.dataType),i.filterOperations&&Array.isArray(i.filterOperations)&&i.filterOperations.length>0&&(a.filterOperations=i.filterOperations),i.lookup&&(a.lookup=i.lookup)}return t._manuallyAddedFields.push(a),t._mapFieldsToMenu(),a}},{key:"_handleFieldChange",value:function(e,t){var a=this,i=e[0],n=t[1],r=t[2],l=t[0],o=a._fields.find(function(t){return t.value===e[1]}),d=a._getFilterOperations(o);if(!i||void 0===n.data[1])return void a._handleOnlyOperation(d,n.data,r);var s=a._fields.find(function(e){return e.value===i}),u=s.dataType,c=o.dataType;if(o!==s&&(c!==u||o.filterOperations||s.filterOperations)){if(!!d.find(function(e){return e.value===n.data[1]})){if(c===u)return;return"date"===c&&"datetime"===u||"datetime"===c&&"date"===u?void(l.firstElementChild.innerHTML=a._formatValueStringRepresentation(n.data[2],n.data[0],n.data[1])):(n.data.splice(2,1),l.setAttribute("placeholder",""),void(l.firstElementChild.innerHTML=a.valuePlaceholder))}n.data.splice(1,2),r.children[1].setAttribute("placeholder",""),r.children[1].firstElementChild.innerHTML=a.operatorPlaceholder,l.setAttribute("placeholder",""),l.firstElementChild.innerHTML=a.valuePlaceholder,l.classList.remove("jqx-visibility-hidden"),a._handleOnlyOperation(d,n.data,r)}}},{key:"_handleOnlyOperation",value:function(e,t,a){if(1===e.length){var i=e[0];t[1]=i.value,a.children[1].removeAttribute("placeholder",""),a.children[1].firstElementChild.innerHTML=e[0].label,("isblank"===i.value||"isnotblank"===i.value||i.custom&&i.hideValue)&&(t.splice(2,1),a.children[2].classList.add("jqx-visibility-hidden"))}}},{key:"_handleOperationChange",value:function(e,t){var a=this,i=e[0],n=e[1],r=e[2],l=t[0],o=t[1],d=void 0!==i.data[1]?a._filterOperationDescriptions.find(function(e){return e.value===i.data[1]}):void 0,s=a._filterOperationDescriptions.find(function(e){return e.value===r}),u=s.value;s!==d&&(i.data[1]=u,l.innerHTML=n,"isblank"===u||"isnotblank"===u||s.custom&&s.hideValue?(i.data.splice(2,1),o.classList.add("jqx-visibility-hidden")):o.classList.contains("jqx-visibility-hidden")?(o.setAttribute("placeholder",""),o.classList.remove("jqx-visibility-hidden"),o.firstElementChild.innerHTML=a.valuePlaceholder):(s.custom||d&&d.custom)&&(i.data.splice(2,1),o.setAttribute("placeholder",""),o.firstElementChild.innerHTML=a.valuePlaceholder))}},{key:"_hideEditor",value:function(e,t){var a=this;t&&e.setAttribute("placeholder",""),e.removeAttribute("edited"),a.$.editorsContainer.removeAttribute("open"),a._editor.close&&a._editor.close(),a._editor.classList.add("jqx-hidden"),a._editorIsOpen=a._enterIsPressedInEditor=!1,a.$.scrollableContainer.refresh()}},{key:"_clickHandlerFilterButton",value:function(e,t,a){function i(e,t,a){n._contextMenuOptions=0===t.length?n._defaultFilterOperationDescriptions:t,n._handleContextMenu(e),n.$.conditionsMenu.opened&&(n.$.conditionsMenu._discardKeyboardHover(),n.$.conditionsMenu._hoverViaKeyboard(n.$.conditionsMenu.querySelector('jqx-menu-item[value="'+a+'"]')))}var n=this;if(!a.closest(".jqx-editors-container")){if(n._closeEditor(),n._editedItem=n._getItemById(t),e.contains("jqx-filter-add-btn"))return void i(a,n._groupOperationDescriptions);if(e.contains("jqx-filter-field-name")||n._editedItem.data&&n._editedItem.data.length)if(e.contains("jqx-filter-group-operator")||e.contains("jqx-filter-nested-operator"))i(a,n._groupOperationDescriptions,n._editedItem.data);else{var r=a.closest(".filter-builder-item");r.removeAttribute("placeholder"),n._openEditor(a)}}}},{key:"_handleContextMenu",value:function(e){var t=this;if(t._selectedElement===e&&t.$.conditionsMenu.opened)return void t.$.conditionsMenu.close();if(t._closeEditor(),t.disableContextMenu)return void(t._selectedElement=e);var a=e.getBoundingClientRect(),i=t.getBoundingClientRect(),n=a.left+t.$.contentContainer.scrollLeft-i.left,r=a.top+t.$.contentContainer.scrollTop-i.top+a.height;t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(n,r+3),t._selectedElement=e,t.$.scrollableContainer.refresh()}},{key:"_openEditor",value:function(e){var t=this,a=e&&e.closest(".jqx-filter-group-condition")?e.closest(".jqx-filter-group-condition").getAttribute("node-id"):null,i=e.closest(".filter-builder-item"),n=t._getItemById(a),r="";void 0!==n.data[0]?r=n.data[0]:t._fields.length&&(r=t._fields[0].value);var l=t._getFieldByFieldName(r),o="",d=void 0,s=void 0;if(i.classList.contains("jqx-filter-field-name"))s=0,t._fields||t._mapFieldsToMenu(),l.lookup={dataSource:t._fields.slice(),readonly:!1},o=l.label||"",d=l.value;else if(i.classList.contains("jqx-filter-operation")){s=1;var u=t._getFilterOperations(l);l.lookup={dataSource:u,readonly:!0};var c=u.find(function(e){return e.value===n.data[s]})||u[0];o=c.label,d=c.value}else s=2,void 0===(o=n.data[s])&&(o="");t._editorIsOpen&&t._closeEditor(),i.setAttribute("edited",""),t._editedItem=n;var v=t._fields,p=v.filter(function(e){return e.value===r}),f=t._filterOperationDescriptions.filter(function(e){return e.value===n.data[1]&&e.custom}),m=p.length>0?p[0]:null,_=l.lookup&&l.lookup.dataSource?"lookup":m.dataType;2===s&&0!==f.length&&f[0].editorTemplate?(t._selectedCustomCondition=f[0],t._openCustomEditor(_,o,l)):t._openEditorByFieldType(_,o,l,d),t._editor.classList.remove("jqx-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),i.appendChild(t.$.editorsContainer),t.$.scrollableContainer.refresh(),l.lookup&&l.lookup.readonly&&t._editor.open()}},{key:"_getFilterOperations",value:function(e){var t=this,a=t._filterOperationDescriptions.slice();if(e.filterOperations)a=t._filterOperationDescriptions.filter(function(t){return e.filterOperations.indexOf(t.value)>-1});else{var i=void 0;switch(e.dataType){case"date":case"datetime":case"number":i=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":i=["=","<>","isblank","isnotblank"];break;case"object":i=["isblank","isnotblank"];break;case"string":i=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:i=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"]}a=t._filterOperationDescriptions.filter(function(e){return i.indexOf(e.value)>-1})}return t.showIcons&&a.map(function(e){return e.icon=t.icons[e.value]}),a}},{key:"_openCustomEditor",value:function(e,t,a){var i=this,n=i.customOperations[i._selectedCustomCondition.index].editorTemplate(e,t,a);i.$.customEditor.innerHTML="",n&&i.$.customEditor.appendChild(n),i._editor=i.$.customEditor}},{key:"_openEditorByFieldType",value:function(e,t,a,i){var n=this;switch(e){case"boolean":n._initializeEditor("checkBox"),n._editor.checked=!!t;break;case"date":case"datetime":n._initializeEditor("dateTimePicker"),n._editor.formatString="date"===e?n.formatStringDate:n.formatStringDateTime,n._editor.value=t;break;case"number":n._initializeEditor("numericTextBox"),n._editor.value=t||0;break;default:n._initializeEditor("input"),n._editor.dropDownWidth=n.dropDownWidth,"lookup"===e?(n._editor.dataSource=a.lookup.dataSource,n._editor.dropDownAppendTo=n.$.container,n._editor.dropDownButtonPosition="right",n._editor.readonly=!!a.lookup.readonly):(n._editor.dataSource=[],n._editor.dropDownButtonPosition="none",n._editor.readonly=!1),"object"===e?n._editor.value=JSON.stringify(t||{}):(""===t&&n._editor.readonly&&(t=a.lookup.dataSource[0].label||""),n._editor.value=t+"",i&&(n._editor.$.input.dataValue=i))}}},{key:"_initializeEditor",value:function(e){var t=this;if(t.$[e+"Editor"])return void(t._editor=t.$[e+"Editor"]);var a=document.createElement("jqx-"+JQX.Utilities.Core.toDash(e));"numericTextBox"===e?(a.spinButtons=!0,a.inputFormat="floatingPoint"):"dateTimePicker"===e&&(a.dropDownAppendTo=t.$.container,a.calendarButton=!0,a.dropDownDisplayMode="auto",a.enableMouseWheelAction=!0,a.locale=t.locale,a.messages[t.locale]||(a.messages[t.locale]={}),a.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),a.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),a.theme=t.theme,a.animation=t.animation,a.$.addClass("jqx-hidden underlined"),t.$.editorsContainer.appendChild(a),t._editor=t.$[e+"Editor"]=a}},{key:"_getValidValue",value:function(){var e=this,t=e.properties.value.value,a=[],i=!1;return t.forEach(function(t){if(Array.isArray(t)){var n=!1,r=!1,l=[];t.forEach(function(t){if(Array.isArray(t)){var a=t[0],i=t[1],o=t[2];if(void 0===a||void 0===i)return void(r=!0);if(void 0!==o||"isblank"===i||"isnotblank"===i)return n=!0,void l.push(t);var d=e._filterOperationDescriptions.find(function(e){return e.value===i});d.custom&&d.hideValue?(n=!0,l.push(t)):r=!0}else r?r=!1:l.push(t)}),n?("string"==typeof l[l.length-1]&&l.pop(),a.push(l)):i=!0}else i?i=!1:a.push(t)}),"string"==typeof a[a.length-1]&&a.pop(),a}}],[{key:"properties",get:function(){return{allowDrag:{value:!1,type:"boolean"},applyMode:{allowValues:["immediately","change"],value:"change",type:"string"},customOperations:{value:[],type:"array",reflectToAttribute:!1},dropDownWidth:{type:"any",value:"100%"},fields:{value:null,type:"array?",reflectToAttribute:!1},fieldsMode:{value:"dynamic",allowedValues:["dynamic","static"],type:"string"},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},getDynamicField:{value:null,type:"function?"},icons:{value:{"=":"equals","<>":"notequals",">":"greaterthan",">=":"greaterthanorequal","<":"lessthan","<=":"lessthanorequal",startswith:"startswith",endswith:"endswith",contains:"contains",notcontains:"notcontains",isblank:"isblank",isnotblank:"isnotblank"},type:"object",reflectToAttribute:!1},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:'{{elementType}}: Wrong parent group index in "{{method}}" method.',wrongElementNode:'{{elementType}}: Incorect node / node Id in "{{method}}" method.',invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME",queryLabel:"Query"}},type:"object",extend:!0},operatorPlaceholder:{value:"Operator",type:"string"},propertyPlaceholder:{value:"Property",type:"string"},showIcons:{value:!1,type:"boolean"},value:{value:[],type:"array?",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"Value",type:"string"}}}},{key:"requires",get:function(){var e={"JQX.Button":"jqxbutton.js","JQX.Calendar":"jqxcalendar.js","JQX.CheckBox":"jqxcheckbox.js","JQX.DateTimePicker":"jqxdatetimepicker.js","JQX.DropDownList":"jqxdropdownlist.js","JQX.Input":"jqxinput.js","JQX.ListBox":"jqxlistbox.js","JQX.Menu":"jqxmenu.js","JQX.NumericTextBox":"jqxnumerictextbox.js","JQX.ScrollBar":"jqxscrollbar.js","JQX.TimePicker":"jqxtimepicker.js","JQX.Tooltip":"jqxtooltip.js","JQX.Utilities.BigNumber":"jqxmath.js","JQX.Utilities.DateTime":"jqxdate.js","JQX.Utilities.Draw":"jqxdraw.js","JQX.Utilities.NumericProcessor":"jqxnumeric.js"};return window.NIComplex||(e["JQX.Utilities.Complex"]="jqxcomplex.js"),e}},{key:"listeners",get:function(){return{down:"_downHandler",move:"_moveHandler",resize:"_resizeHandler","editorsContainer.keydown":"_innerContainerKeydownHandler","conditionsMenu.closing":"_menuClosingHandler","conditionsMenu.itemClick":"_menuItemClickHandler","contentContainer.change":"_contentContainerChangeHandler","document.down":"_documentDownHandler","document.move":"_documentMoveHandler","document.up":"_documentUpHandler"}}},{key:"styleUrls",get:function(){return["jqx.querybuilder.css"]}}]),t}(JQX.BaseElement));
//# sourceMappingURL=jqxfilterbuilder.js.map
